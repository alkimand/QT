BEM.DOM.decl("notifier",{onSetMod:{js:{inited:function(){this._popup=this.getPopup(),this._spin=this.getSpin(),this.win=window,this._popup.on("beforeOpen beforeClose",function(){var e=this._popup.hasMod("visible","yes");this.toggleMod("opened","yes",!e),e?this._firstOpen=!1:(this.delMod("has-unread"),this._firstOpen=void 0===this._firstOpen||void 0),this._hasLoaded||this._spin.setMod("progress","yes")}.bind(this)),this._fetchCounter()}}},_fetchCounter:function(){return $.ajax({url:this._getCounterUrl(),dataType:"json",type:"GET",xhrFields:{withCredentials:!0}}).promise().then(function(e){if(e&&e.records.items.length)return e.records.items.reduce(function(e,t){var i=0;return t.fields.forEach(function(e){"unviewed_count"===e.field_id&&(i=e.value.integer)}),e+i},0)}).then(this.onUpdateCounter.bind(this))},_getCounterUrl:function(){return this.params.counterHandle||this.params.apiHost+"v1/data/app/databases/.ext.notifier@notifications_disk/snapshot?collection_id=meta"},_getIframeUrl:function(e){return this.params.iframeUrl||this.params.baseUrl+"/yandex-notifications/"+this.params.iframeVersion+"/iframe/index."+e+".html"},_getLoaderUrl:function(){return this.params.loaderUrl||this.params.baseUrl+"/iframe-loader/"+this.params.loaderVersion+"/index.min.js"},_insertLoaderScript:function(e){var t=document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0],i=document.createElement("script");i.setAttribute("src",this._getLoaderUrl()),t.insertBefore(i,t.lastChild),i.onload=e},_loadIframe:function(){var e={iframeUrl:this._getIframeUrl(this.params.lang),container:this.findElem(this._popup.domElem,"content").get(0)};this._atom=new window.LegoIframeLoader(e),this._rpcBridge=this._atom.getRPCBridge(this),this._atom.on("init",function(e,t){this._onIframeLoad(t)}.bind(this)),this._atom.init()},getPopup:function(){return this._popup||this.findBlockOn("popup","popup2")},getSpin:function(){return this._spin||this.getPopup().findBlockInside("spin2")},init:function(){if(this._rpcBridge)return this;window.LegoIframeLoader?this._loadIframe():this._insertLoaderScript(this._loadIframe.bind(this))},onIconClick:function(e){this._rpcBridge||this.init(),!this._popup.hasMod("visible","yes")&&this._rpcBridge&&this._hasLoaded&&this._rpcBridge.invokeMethod("resetUnviewed",{}),this._popup.toggleMod("visible","yes")},onDataLoad:function(e){this.setMod(this._popup.domElem,"loaded","yes"),this._spin.delMod("progress"),this._hasLoaded=!0,this._popup.hasMod("visible","yes")&&this._rpcBridge.invokeMethod("resetUnviewed",{})},onUpdateCounter:function(e){this.toggleMod("has-unread","yes",!this._firstOpen&&Boolean(e)),this._firstOpen&&(this._firstOpen=!1)},updateCounterWithParams:function(e,t){void 0!==this._rpcBridge&&void 0!==this._rpcBridge.contrAgent.win&&this._rpcBridge.invokeMethod("updateCounterWithParams",{counterParams:e,referrer:t})},_onIframeLoad:function(e){this._rpcBridge.contrAgent.win=e.iframeWin,this._rpcBridge.invokeMethod("onIframeLoad",{source:this.params.source,serviceDatabaseId:this.params.serviceDatabaseId,services:this.params.services,domain:this.params.domain||this.params.tld,counterParams:this.params.counterParams,referrer:this.params.referrer,apiHost:this.params.apiHost})},onInit:function(e){},getDefaultParams:function(){return{baseUrl:"https://gcn.yandex-team.ru",loaderVersion:"stable",iframeVersion:"stable",lang:"ru",referrer:location.href}}},{live:function(){this.liveBindTo("click",function(e){this.onIconClick(e)})}}),BEM.DOM.decl("notifier",{onSetMod:{js:{inited:function(){this.__base.apply(this,arguments),this._popup.attachToScope(),this._popup.setAnchor(this.elem("box"))}}}}),BEM.DOM.decl("notifier",{onSetMod:{js:{inited:function(){this.__base.apply(this,arguments),this.hasMod("header")&&this.insertIntoHeader()}}},insertIntoHeader:function(){this._getHeader().replacePlaceholder("notifier",this)},_getHeader:function(){return BEM.blocks["serp-header"]}}),BEM.DOM.decl("notifier",{_getHeader:function(){return BEM.blocks.header}}),BEM.DOM.decl("notifier",{_getHeader:function(){return BEM.blocks["serp-header"]}}),BEM.DOM.decl("notifier",{onSetMod:{js:{inited:function(){this.__base.apply(this,arguments),BEM.DOM.blocks["cbir-panel"].on({modName:"visibility",modVal:"visible"},function(){this._popup.delMod("visible")},this)}}}}),BEM.DOM.decl("notifier",{onSetMod:{opened:{yes:function(){this.__base.apply(this,arguments),!1===this._firstOpen&&this.updateCounterWithParams(this._updateCounterParams(),location.href)}}},_updateCounterParams:function(){return this.params.counterParams.reqid=BEM.blocks["i-global"].param("reqid"),this.params.counterParams.serpid=BEM.blocks["i-global"].param("serpid"),this.params.counterParams}}),BEM.DOM.decl("notifier",{onSetMod:{js:{inited:function(){this.__base.apply(this,arguments),this._updateCounterParams()}}},_updateCounterParams:function(){return this.__base.apply(this,arguments),BEM.blocks["i-global"].extendCounterParams(this.params.counterParams),this.params.counterParams}});